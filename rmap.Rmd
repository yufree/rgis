---
title: "地理信息系统中的R－用R画地图"
author: "Miao YU"
date: "2014年12月2日"
output: html_document
---

好了，你现在应该比较熟悉R了（不熟悉也没关系，反正有些知识早学晚不学）。R关于GIS有一个整合[网页](http://cran.r-project.org/web/views/Spatial.html)，你要是全都读过了后面的都别看了，有损我在你心中的形象。

# 空间数据类型

让R识别并绘制地图数据就要对这种数据类型进行定义，然后告诉R用什么样的方法去处理该类型数据。GIS中空间数据类型有两种，想像成矢量图与位图就可以了。不过我们不用去关心底层编码的事，有一个名为`sp`的扩展包基本上做了一个转接器，所有R不认识的地图格式都去转化为`sp`包定义的数据对象，而所有对空间数据分析的包都大概可以使用`sp`包的数据对象。就好比语言，各家软件公司说的语言就他们的用户懂，现在出来个翻译，把他们统统转化为一种语言并且规定以后就用这种语言来交流，这就省事多了。例如：

```{r}
# 读入sp包，没安装用install.packages('sp') 安装
library(sp)
# 读入数据
data(meuse)
# 观察数据
class(meuse)
str(meuse)
# 我们可以看到这个数据集的类型为meuse，有155个样本，每个样本14个属性
# 绘制图像
plot(meuse, pch=1, cex = .05*sqrt(meuse$zinc))

# 按照数据中的x y生成空间数据点
coords <- SpatialPoints(meuse[c("x", "y")])
# 将数据点与后面的属性连接生成空间点数据数据框类型
meuse <- SpatialPointsDataFrame(coords, meuse)
class(meuse)
# 绘制数据点，点的大小对应其中一个属性
plot(meuse, pch=1, cex = .05*sqrt(meuse$zinc))
```

在这个例子中，我们将传统的数据框数据类型（data.frame）转换为了空间点数据框类型（SpatialPointsDataFrame）。这个类型就可以被其他处理空间类型的函数所识别并进行处理，这里你大概也就明白了R中数据类型的概念。数据类型对应相应的处理方法，这样同样是绘图命令，在识别了数据类型后，R就可以绘制出对应数据类型的图像，例如刚才同样的命令R绘制出的图就不一样。有了数据类型的区分，我们对某一种数据类型的处理方法就可以更有针对性。这样你也就明白了，我们把所有其他软件格式的数据转化为`sp`包的格式，然后针对这个格式写数据处理的方法其实就是通过数据类型的识别来实现的。这个例子中我们转化的是空间点数据，类似的我们可以转化成空间像素数据（对应位图），空间网格数据（对应空间坐标系），空间线数据（对应空间中的线对象），空间多边形数据（对应空间中多边形对象）。在`sp`包中，空间线数据与空间多边形数据都可以有多个内含的子线段或空间多边形，用来对应湖泊等地理对象，其余的属性都存在对应数据类型的`AttributeList`中。为了节约内存，数据框对象在转换为空间数据框时`rowname`会被删除，所以最好单独存为一列。以上就是`sp`包提供的空间数据类型，有了这个“变压器”，我们就可以将外来数据输入进来了。

# 空间数据读取

常见的空间数据格式为`*.shp`文件，我在这里不去解析这个文件结构了，你只要知道这个文件可以被`maptools`包中的`readShapePoly`函数读取为`sp`包的空间数据格式就可以了。但比较杯具的是这个包只管读取多边形数据，同样保存在`*.shp`文件中的属性就不管了，这时候建议使用`rgdal`包中的`readOGR`函数来读取。当我们将常见数据转换到`sp`包的数据类型后，我建议使用`raster`包中的函数`raster`转换为`raster`包内的数据类型。原因是这个包提供了更丰富的GIS函数功能，不过眼下我们只关注画出图来，这个可以不考虑（其实也可以[直接](http://www.r-bloggers.com/converting-shapefiles-to-rasters-in-r/)用`raster`包读取`*.shp`文件）。在数据读取时，你最好注意下原始数据的坐标投影方式，例如：
```{r message=FALSE}
# rworldmap提供了很多现成的地图
library(rworldmap)
# 来张地球行政图
data(countriesLow)
plot(countriesLow)
# 更换投影方式
library(rgdal)
country <- spTransform(countriesLow, CRS("+proj=laea +lat_0=23 +lon_0=120 +ellps=GRS80 +units=m +no_defs"))
# 再次绘图
plot(country)
```

其实现在很多R包都提供了一些现成的数据或数据接口，我们不用去费事理解数据结构，基本只要给出我感兴趣的经纬度范围或者国家或者地名就可以提取相应的地图。这个下次讲，这次主要理解R中地图的数据类型与读取。
